# ============================================
# MLOps CI Pipeline
# ============================================
# Single Source of Truth: All commands flow through the Makefile
# Environment: Poetry (pip-based, reproducible)
# ============================================

name: MLOps CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  PYTHON_VERSION: "3.12"
  POETRY_VERSION: "1.7.1"

jobs:
  # ============================================
  # Quality Checks
  # ============================================
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Run type checking
        run: make type-check

      - name: Run tests
        run: make test

      - name: Run Integration Tests
        run: make test-serving

  # ============================================
  # Infrastructure Tests
  # ============================================
  infrastructure-test:
    name: Infrastructure Tests
    runs-on: ubuntu-latest
    needs: quality

    services:
      # We don't need service containers here because we use docker compose in the steps
      # But we need basic docker availability
      docker:
        image: docker:dind

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false # We use tflocal

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Start AWS Infrastructure (LocalStack, Terraform, S3 sync)
        run: make infra-up

      - name: Start MLOps Services (Postgres, MLflow, Airflow)
        run: make ml-services-up

      - name: Validate Infrastructure
        run: |
          echo "üîç Checking S3 buckets..."
          poetry run awslocal s3 ls

          echo "üîç Checking Service Health..."
          # LocalStack
          curl -f http://localhost:4566/_localstack/health

          # PostgreSQL
          docker exec mlflow-postgres pg_isready -U mlflow || echo "PostgreSQL check failed"

          # MLflow UI
          curl -f http://localhost:5001/health || echo "MLflow UI check skipped (might be behind proxy/redirect)"

          echo "‚úÖ Infrastructure validation complete"

      - name: Stop MLOps Services
        if: always()
        run: make ml-services-down

      - name: Stop AWS Infrastructure
        if: always()
        run: make infra-down
