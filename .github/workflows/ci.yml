# ============================================
# MLOps CI Pipeline (Continuous Integration)
# ============================================
# Single Source of Truth: All commands flow through the Makefile
# Environment: Poetry (pip-based, reproducible)
# ============================================
# This workflow handles:
# - Quality checks and testing
# - Infrastructure validation
# - Docker image building and pushing
# ============================================

name: MLOps CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      build_images:
        description: 'Build and push Docker images'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.12"
  POETRY_VERSION: "1.7.1"

jobs:
  # ============================================
  # Quality Checks
  # ============================================
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    outputs:
      app_changed: ${{ steps.changes.outputs.app_changed }}
      infra_changed: ${{ steps.changes.outputs.infra_changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for change detection

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Run type checking
        run: make type-check

      - name: Run tests
        run: make test

      - name: Run Integration Tests
        run: make test-serving

      # Detect what changed for conditional jobs
      - name: Detect changes
        id: changes
        if: github.event_name == 'push'
        run: |
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            # Initial commit, check all files
            if find src serving -type f -name "*.py" 2>/dev/null | head -1 | grep -q .; then
              echo "app_changed=true" >> $GITHUB_OUTPUT
            else
              echo "app_changed=false" >> $GITHUB_OUTPUT
            fi
            # Check infrastructure folders
            if [ -d "mlops_services" ] || [ -d "infra_aws" ]; then
              echo "infra_changed=true" >> $GITHUB_OUTPUT
            else
              echo "infra_changed=false" >> $GITHUB_OUTPUT
            fi
          else
            # Check for app code changes (src/ or serving/ directories)
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "")
            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Check if any file in src/ or serving/ directories changed
            if echo "$CHANGED_FILES" | grep -qE '^(src/|serving/)'; then
              echo "app_changed=true" >> $GITHUB_OUTPUT
              echo "âœ… App code changed detected"
            else
              echo "app_changed=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  No app code changes"
            fi

            # Check for infrastructure changes (mlops_services/ or infra_aws/ directories)
            if echo "$CHANGED_FILES" | grep -qE '^(mlops_services/|infra_aws/)'; then
              echo "infra_changed=true" >> $GITHUB_OUTPUT
              echo "âœ… Infrastructure changed detected"
            else
              echo "infra_changed=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  No infrastructure changes"
            fi
          fi

  # ============================================
  # Infrastructure Tests
  # ============================================
  infrastructure-test:
    name: Infrastructure Tests
    runs-on: ubuntu-latest
    needs: quality
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && needs.quality.outputs.infra_changed == 'true')

    services:
      docker:
        image: docker:dind

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Start AWS Infrastructure (LocalStack, Terraform, S3 sync)
        run: make infra-up

      - name: Start MLOps Services (Postgres, MLflow, Airflow)
        run: make ml-services-up

      - name: Validate Infrastructure
        run: |
          echo "ðŸ” Checking S3 buckets..."
          poetry run awslocal s3 ls

          echo "ðŸ” Checking Service Health..."
          curl -f http://localhost:4566/_localstack/health
          docker exec mlflow-postgres pg_isready -U mlflow || echo "PostgreSQL check failed"
          curl -f http://localhost:5001/health || echo "MLflow UI check skipped"

          echo "âœ… Infrastructure validation complete"

      - name: Stop MLOps Services
        if: always()
        run: make ml-services-down

      - name: Stop AWS Infrastructure
        if: always()
        run: make infra-down

  # ============================================
  # Build and Push Docker Images
  # ============================================
  build-images:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: quality
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.quality.outputs.app_changed == 'true') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.build_images == 'true')

    outputs:
      image_tag: ${{ steps.meta.outputs.short_sha }}
      api_image: ${{ steps.meta.outputs.docker_username }}/mlops-serving-api:${{ steps.meta.outputs.short_sha }}
      ui_image: ${{ steps.meta.outputs.docker_username }}/mlops-serving-ui:${{ steps.meta.outputs.short_sha }}
      commit_sha: ${{ github.sha }}
      docker_username: ${{ steps.meta.outputs.docker_username }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Generate image tags
        id: meta
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "docker_username=${{ secrets.DOCKER_USERNAME }}" >> $GITHUB_OUTPUT
          echo "âœ… Generated image tag: $SHORT_SHA"

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./serving/docker/Dockerfile.serving
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/mlops-serving-api:${{ steps.meta.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push UI image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./serving/docker/Dockerfile.ui
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/mlops-serving-ui:${{ steps.meta.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image information
        run: |
          echo "âœ… Images built and pushed:"
          echo "  API: ${{ secrets.DOCKER_USERNAME }}/mlops-serving-api:${{ steps.meta.outputs.short_sha }}"
          echo "  UI: ${{ secrets.DOCKER_USERNAME }}/mlops-serving-ui:${{ steps.meta.outputs.short_sha }}"
