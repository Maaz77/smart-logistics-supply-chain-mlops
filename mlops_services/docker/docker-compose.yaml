# ============================================
# Docker Compose - MLOps Services (PostgreSQL + MLflow)
# ============================================
# MLOps infrastructure services for local ML development
# Usage: docker compose -f mlops_services/docker/docker-compose.yaml up -d
# ============================================
#
# Persistent Storage Design:
# - data/           → synced with s3://smart-logistics-data
# - models/         → synced with s3://mlflow-model-registry (MLflow artifacts)
# - postgres_data/  → PostgreSQL data for all services (mlflow, airflow, monitoring, serving)
#
# These folders persist after infrastructure is shut down.
#
# NOTE: S3 buckets are created by Terraform (make infra-init), not here.
# NOTE: LocalStack must be running (from infra_aws) for MLflow S3 artifacts.
# ============================================

services:
  # ============================================
  # PostgreSQL - Unified Database for All Services
  # ============================================
  # Single PostgreSQL container hosting multiple databases:
  # - mlflow: MLflow experiment tracking
  # - airflow: Airflow metadata store
  # - monitoring: Monitoring metrics (Evidently)
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: mlops-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-MLOps_Full_Postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-MLOps_Full_Postgres}
      POSTGRES_DB: ${POSTGRES_DB:-mlflow}  # Default database, others created via init script
    ports:
      - "5432:5432"
    volumes:
      # Persist PostgreSQL data in mlops_services folder
      - "../postgres_data:/var/lib/postgresql/data"
      # Init script to create all databases
      - "./init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-MLOps_Full_Postgres} -d ${POSTGRES_DB:-mlflow}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - mlops_network

  # ============================================
  # MLflow Tracking Server
  # ============================================
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.9.2
    container_name: mlflow-server
    depends_on:
      postgres:
        condition: service_healthy
    # Note: localstack should be running (from infra-up) but is in a separate compose file
    # Both services use the same mlops_network, so they can communicate by service name
    ports:
      - "5001:5000"  # External 5001 -> Internal 5000 (avoids macOS AirPlay conflict)
    environment:
      # MLflow backend store configuration (Postgres)
      MLFLOW_BACKEND_STORE_URI: postgresql://${POSTGRES_USER:-MLOps_Full_Postgres}:${POSTGRES_PASSWORD:-MLOps_Full_Postgres}@postgres:5432/mlflow
      # MLflow artifact store configuration (S3 via LocalStack - model registry bucket)
      MLFLOW_DEFAULT_ARTIFACT_ROOT: s3://mlflow-model-registry
      # S3 endpoint for LocalStack (container-to-container communication)
      MLFLOW_S3_ENDPOINT_URL: http://localstack:4566
      # AWS credentials for LocalStack
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
    command: >
      bash -c "pip install psycopg2-binary boto3 --quiet &&
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri postgresql://${POSTGRES_USER:-MLOps_Full_Postgres}:${POSTGRES_PASSWORD:-MLOps_Full_Postgres}@postgres:5432/mlflow
      --default-artifact-root s3://mlflow-model-registry"
    networks:
      - mlops_network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health').read()"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # Adminer - Database Administration UI
  # ============================================
  adminer:
    image: adminer
    container_name: adminer
    ports:
      - "8081:8080"
    networks:
      - mlops_network
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ============================================
# Networks - Join existing mlops_network
# ============================================
# Network is created by infra_aws/docker/docker-compose.yaml
# If network doesn't exist, run: make infra-up first
networks:
  mlops_network:
    external: true
    name: mlops_network
