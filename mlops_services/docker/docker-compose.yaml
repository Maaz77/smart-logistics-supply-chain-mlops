# ============================================
# Docker Compose - MLOps Services (PostgreSQL + MLflow)
# ============================================
# MLOps infrastructure services for local ML development
# Usage: docker compose -f mlops_services/docker/docker-compose.yaml up -d
# ============================================
#
# Persistent Storage Design:
# - data/           → synced with s3://smart-logistics-data
# - models/         → synced with s3://mlflow-model-registry (MLflow artifacts)
# - mlflow_db/      → PostgreSQL data for MLflow experiments
#
# These folders persist after infrastructure is shut down.
#
# NOTE: S3 buckets are created by Terraform (make infra-init), not here.
# NOTE: LocalStack must be running (from infra_aws) for MLflow S3 artifacts.
# ============================================

services:
  # ============================================
  # PostgreSQL - MLflow Backend Store
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: mlflow-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-mlflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mlflow}
      POSTGRES_DB: ${POSTGRES_DB:-mlflow}
    ports:
      - "5432:5432"
    volumes:
      # Persist PostgreSQL data in mlops_services folder
      - "../mlflow_db:/var/lib/postgresql/data"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mlflow} -d ${POSTGRES_DB:-mlflow}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - mlops_network

  # ============================================
  # MLflow Tracking Server
  # ============================================
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.9.2
    container_name: mlflow-server
    depends_on:
      postgres:
        condition: service_healthy
    # Note: localstack should be running (from infra-up) but is in a separate compose file
    # Both services use the same mlops_network, so they can communicate by service name
    ports:
      - "5001:5000"  # External 5001 -> Internal 5000 (avoids macOS AirPlay conflict)
    environment:
      # MLflow backend store configuration (Postgres)
      MLFLOW_BACKEND_STORE_URI: postgresql://${POSTGRES_USER:-mlflow}:${POSTGRES_PASSWORD:-mlflow}@postgres:5432/${POSTGRES_DB:-mlflow}
      # MLflow artifact store configuration (S3 via LocalStack - model registry bucket)
      MLFLOW_DEFAULT_ARTIFACT_ROOT: s3://mlflow-model-registry
      # S3 endpoint for LocalStack (container-to-container communication)
      MLFLOW_S3_ENDPOINT_URL: http://localstack:4566
      # AWS credentials for LocalStack
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
    command: >
      bash -c "pip install psycopg2-binary boto3 --quiet &&
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri postgresql://${POSTGRES_USER:-mlflow}:${POSTGRES_PASSWORD:-mlflow}@postgres:5432/${POSTGRES_DB:-mlflow}
      --default-artifact-root s3://mlflow-model-registry"
    networks:
      - mlops_network

# ============================================
# Networks - Join existing mlops_network
# ============================================
networks:
  mlops_network:
    external: true
    name: mlops_network
